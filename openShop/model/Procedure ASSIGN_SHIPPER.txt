BEGIN
DECLARE LIM INT(11) DEFAULT 7;
DECLARE NOW INT(11) DEFAULT 0;
DECLARE VAL INT(11) DEFAULT 0;
DECLARE TARIKH DATE;
DECLARE TOT INT;
DECLARE FLAG INT DEFAULT 0;

DECLARE done INT DEFAULT FALSE;
DECLARE ID INT(11);
DECLARE CUR1 CURSOR FOR SELECT shipper_id FROM shipper WHERE shipper_district=DISTRICT;
DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;


SELECT CURDATE() INTO TARIKH;

DO_IT: WHILE NOW<LIM DO

OPEN CUR1;
SET done=0;

MYLOOP: LOOP
FETCH CUR1 INTO ID; 

SELECT COUNT(*) INTO VAL FROM shipment_details WHERE shipper_id=ID AND delivery_date=TARIKH;

IF VAL<=3 THEN
SET TOT=(QUANTITY*U_PRICE);
INSERT INTO shipment_details VALUES(ID,ODR_ID,TARIKH,TOT);
SET FLAG=1;
LEAVE MYLOOP;
END IF;

IF done THEN
LEAVE MYLOOP;
END IF;


END LOOP MYLOOP;
CLOSE CUR1;

IF FLAG=1 THEN
LEAVE DO_IT;
END IF;

SET NOW=NOW+1;
SELECT DATE_ADD(TARIKH,INTERVAL 1 DAY) INTO TARIKH;

END WHILE DO_IT;


IF FLAG=0 THEN
SET RET=-1;
ELSE
SET RET=1;
END IF;

END